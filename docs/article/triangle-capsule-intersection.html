<!doctype html>
<html lang=en>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">

		<title>Triangle - Capsule Intersection - photodiode</title>

		<base href="https://photodiode.github.io/">

		<link rel="icon" href="favicon.png?v=0">
		<link rel="stylesheet" href="style.css">
	</head>
	<body class="">
		<header>
			<h1><a href="/">photodiode</a></h1>
		</header>
		<main>
<article>
<h1>Triangle - Capsule Intersection</h1>
<time datetime="2021-11-27">2021.11.27</time>

<p>Some time ago I needed a function to find the intersection point between a capsule or SSV (Swept Sphere Volume) and a triangle. This took me surprisingly long to find information about and the ones I did find all seemed pretty complicated.</p>
<p>I ended up making my own algorithm. I have no idea if it's any good or not, I'm not that smart, but it seems to work well.</p>
<h3>How it works</h3>
<ul>
<li>Make an infinite plane out of the triangle surface</li>
<li>Move this plane towards the origin of the ray capsule by it's radius</li>
<li>Check if we intersect this plane</li>
<li>If an intersection point is found check if the point is outside the triangle (as projected onto the moved plane)</li>
<li><strong>If outside:</strong></li>
<li>Find the closest edge to the capsule</li>
<li>Perform a ray / capsule intersect test</li>
<li>If it intersected calculate the capsule hit normal</li>
<li><strong>If inside:</strong></li>
<li>Get the normal</li>
</ul>
<p>The functions <a href="https://www.iquilezles.org/www/articles/intersectors/intersectors.htm"><code>ray_capsule_intersect</code></a>, <a href="https://www.iquilezles.org/www/articles/distfunctions/distfunctions.htm"><code>point_line_distance</code></a> and <code>capsule_normal</code> are all taken from <a href="https://www.iquilezles.org/">iquilezles.org</a>.</p>
<p>I hope this helps anyone searching for the same as I did.</p>
<h3>The code</h3>
<pre><code><line><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">point_line_distance</span><span class="p">(</span><span class="n">v3f</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">ba</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">ba</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">              </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fminf</span><span class="p">(</span><span class="n">fmaxf</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">),</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">v3f_len</span><span class="p">(</span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">v3f_scale</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">)));</span><span class="w"></span></line>
<line><span class="p">}</span><span class="w"></span></line>
<line></line>
<line></line>
<line><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ray_capsule_intersect</span><span class="p">(</span><span class="n">v3f</span><span class="w"> </span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">pb</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">ra</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">distance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">oa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="n">pa</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">baba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">ba</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">bard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">rd</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">baoa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">oa</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">rdoa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">oa</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">oaoa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">oa</span><span class="p">,</span><span class="w"> </span><span class="n">oa</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baba</span><span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">bard</span><span class="o">*</span><span class="n">bard</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baba</span><span class="o">*</span><span class="n">rdoa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">baoa</span><span class="o">*</span><span class="n">bard</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baba</span><span class="o">*</span><span class="n">oaoa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">baoa</span><span class="o">*</span><span class="n">baoa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ra</span><span class="o">*</span><span class="n">ra</span><span class="o">*</span><span class="n">baba</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">))</span><span class="o">/</span><span class="n">a</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baoa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="n">bard</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="c1">// body</span></line>
<line><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">baba</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line><span class="w">                        </span><span class="o">*</span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                </span><span class="p">}</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="c1">// caps</span></line>
<line><span class="w">                </span><span class="n">v3f</span><span class="w"> </span><span class="n">oc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">oa</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span><span class="w"> </span><span class="n">pb</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">oc</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ra</span><span class="o">*</span><span class="n">ra</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line><span class="w">                        </span><span class="o">*</span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sqrtf</span><span class="p">(</span><span class="n">h</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                </span><span class="p">}</span><span class="w"></span></line>
<line><span class="w">        </span><span class="p">}</span><span class="w"></span></line>
<line><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line><span class="p">}</span><span class="w"></span></line>
<line></line>
<line></line>
<line><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="nf">capsule_normal</span><span class="p">(</span><span class="n">v3f</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">ba</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">ba</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">ba</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">              </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fminf</span><span class="p">(</span><span class="n">fmaxf</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">),</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">v3f_divs</span><span class="p">(</span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span><span class="w"> </span><span class="n">v3f_scale</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">)),</span><span class="w"> </span><span class="n">r</span><span class="p">);</span><span class="w"></span></line>
<line><span class="p">}</span><span class="w"></span></line>
<line></line>
<line></line>
<line><span class="kt">bool</span><span class="w"> </span><span class="nf">ssv_triangle_intersect</span><span class="p">(</span><span class="n">v3f</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="n">distance</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="o">*</span><span class="n">hit_point</span><span class="p">,</span><span class="w"> </span><span class="n">v3f</span><span class="w"> </span><span class="o">*</span><span class="n">hit_normal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="c1">// plane normal</span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">e0</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">e1</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">e0e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_cross</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">pn</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_normalize</span><span class="p">(</span><span class="n">e0e1</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="c1">// ----</span></line>
<line></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">cap_len</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_len</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w">   </span><span class="n">cap_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_normalize</span><span class="p">(</span><span class="n">velocity</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">denom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span><span class="w"> </span><span class="n">cap_normal</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">denom</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.00001f</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="c1">// grow plane thickness by radius towards origin</span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">r</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">denom</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">radius</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="n">radius</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w">   </span><span class="n">po</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_add</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v3f_scale</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">));</span><span class="w"></span></line>
<line><span class="w">        </span><span class="c1">// ----</span></line>
<line></line>
<line><span class="w">        </span><span class="c1">// find intersection point</span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">po</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">denom</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cap_len</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_add</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">v3f_scale</span><span class="p">(</span><span class="n">cap_normal</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span><span class="w"></span></line>
<line><span class="w">        </span><span class="c1">// ----</span></line>
<line></line>
<line><span class="w">        </span><span class="c1">// is projected point outside triangle</span></line>
<line><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">outside</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="n">v3f</span><span class="w">   </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_sub</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">v3f_cross</span><span class="p">(</span><span class="n">e0</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">),</span><span class="w"> </span><span class="n">e0e1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v3f_norm2</span><span class="p">(</span><span class="n">e0e1</span><span class="p">);</span><span class="w"> </span><span class="c1">// γ=[(u×w)⋅n]/n²</span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_dot</span><span class="p">(</span><span class="n">v3f_cross</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">),</span><span class="w"> </span><span class="n">e0e1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v3f_norm2</span><span class="p">(</span><span class="n">e0e1</span><span class="p">);</span><span class="w"> </span><span class="c1">// β=[(w×v)⋅n]/n²</span></line>
<line><span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="mf">0.0f</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span></line>
<line><span class="w">            </span><span class="p">(</span><span class="mf">0.0f</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span></line>
<line><span class="w">            </span><span class="p">(</span><span class="mf">0.0f</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1.0f</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line><span class="w">                </span><span class="n">outside</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="p">}</span><span class="w"></span></line>
<line><span class="w">        </span><span class="c1">// ----</span></line>
<line></line>
<line><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outside</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span></line>
<line><span class="w">                </span><span class="c1">// find closest edge</span></line>
<line><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">d1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_line_distance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_line_distance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">d3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">point_line_distance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">);</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="n">v3f</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                </span><span class="n">v3f</span><span class="w"> </span><span class="n">vb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="kt">float</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d1</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">;</span><span class="w">  </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">;</span><span class="w">  </span><span class="n">vb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v2</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></line>
<line><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">d3</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">           </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v2</span><span class="p">;</span><span class="w">  </span><span class="n">vb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span></line>
<line><span class="w">                </span><span class="c1">// ----</span></line>
<line></line>
<line><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ray_capsule_intersect</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">cap_normal</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">vb</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cap_len</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">                </span><span class="n">p</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">v3f_add</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">v3f_scale</span><span class="p">(</span><span class="n">cap_normal</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">));</span><span class="w"></span></line>
<line><span class="w">                </span><span class="n">pn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capsule_normal</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">vb</span><span class="p">,</span><span class="w"> </span><span class="n">radius</span><span class="p">);</span><span class="w"></span></line>
<line><span class="w">        </span><span class="p">}</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0f</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="o">*</span><span class="n">distance</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="o">*</span><span class="n">hit_point</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span></line>
<line><span class="w">        </span><span class="o">*</span><span class="n">hit_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pn</span><span class="p">;</span><span class="w"></span></line>
<line></line>
<line><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span></line>
<line><span class="p">}</span><span class="w"></span></line>
</code></pre>

</article>
		</main>
		<footer>
			<section id="links">
				<a href="https://github.com/photodiode" target="_blank" class="github">github.com/photodiode</a>
				<a href="https://photodiode.itch.io" target="_blank" class="itchio">photodiode.itch.io</a>
				<a href="https://twitter.com/pinphotodiode" target="_blank" class="twitter">twitter.com/pinphotodiode</a>
				<a href="https://addons.mozilla.org/en-US/firefox/addon/panorama-view" target="_blank" class="firefox">Firefox Addon</a>
			</section>
		</footer>
	</body>
</html>
